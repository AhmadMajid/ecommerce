<% content_for(:title, @product.name) %>
<% content_for(:description, @product.short_description.presence || @product.description.presence || "#{@product.name} - Shop now at EcommerceStore") %>

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <!-- Breadcrumb -->
  <nav class="mb-8">
    <ol class="flex items-center space-x-2 text-sm text-gray-500">
      <li><%= link_to "Home", root_path, class: "hover:text-gray-700" %></li>
      <li><span class="mx-2">/</span></li>
      <li><%= link_to "Products", products_path, class: "hover:text-gray-700" %></li>
      <li><span class="mx-2">/</span></li>
      <li><%= link_to @product.category.name, category_path(@product.category), class: "hover:text-gray-700" %></li>
      <li><span class="mx-2">/</span></li>
      <li class="text-gray-900 font-medium"><%= truncate(@product.name, length: 50) %></li>
    </ol>
  </nav>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 mb-16">
    <!-- Product Images -->
    <div class="space-y-4"
         data-controller="product-gallery"
         data-product-gallery-zoom-value="false"
         data-action="keydown@window->product-gallery#keydown">
      <!-- Main Image -->
      <div class="aspect-square bg-gray-100 rounded-lg overflow-hidden relative"
           data-product-gallery-target="zoomContainer"
           data-action="click->product-gallery#toggleZoom">
        <% if @product.primary_image %>
          <%= image_tag @product.primary_image,
              id: "main-product-image",
              class: "w-full h-full object-cover cursor-zoom-in transition-transform duration-300",
              alt: @product.name,
              data: {
                product_gallery_target: "mainImage"
              } %>
        <% else %>
          <div class="w-full h-full flex items-center justify-center">
            <svg class="w-24 h-24 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
          </div>
        <% end %>

        <!-- Navigation Buttons -->
        <% if @product.images.count > 1 %>
          <button class="absolute left-2 top-1/2 transform -translate-y-1/2 bg-white bg-opacity-75 hover:bg-opacity-100 rounded-full p-2 shadow-md transition-all"
                  data-action="click->product-gallery#previousImage"
                  aria-label="Previous image">
            <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
          </button>

          <button class="absolute right-2 top-1/2 transform -translate-y-1/2 bg-white bg-opacity-75 hover:bg-opacity-100 rounded-full p-2 shadow-md transition-all"
                  data-action="click->product-gallery#nextImage"
                  aria-label="Next image">
            <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
          </button>
        <% end %>
      </div>

      <!-- Thumbnail Images -->
      <% if @product.images.count > 1 %>
        <div class="grid grid-cols-4 gap-2">
          <% @product.images.each_with_index do |image, index| %>
            <button class="aspect-square bg-gray-100 rounded-md overflow-hidden border-2 <%= index == 0 ? 'border-indigo-500' : 'border-transparent hover:border-gray-300' %> transition-all cursor-pointer"
                    data-product-gallery-target="thumbnail"
                    data-image="<%= url_for(image) %>"
                    data-alt="<%= @product.name %>"
                    data-index="<%= index %>"
                    data-action="click->product-gallery#selectImage">
              <%= image_tag image,
                  class: "w-full h-full object-cover",
                  alt: "#{@product.name} - Image #{index + 1}" %>
            </button>
          <% end %>
        </div>
      <% end %>
    </div>

    <!-- Product Information -->
    <div class="space-y-6">
      <!-- Product Title & Category -->
      <div>
        <p class="text-sm text-indigo-600 font-medium mb-2">
          <%= link_to @product.category.name, category_path(@product.category),
              class: "hover:text-indigo-800" %>
        </p>
        <h1 class="text-3xl font-bold text-gray-900 mb-4"><%= @product.name %></h1>

        <!-- Rating (placeholder) -->
        <div class="flex items-center space-x-2 mb-4">
          <div class="rating-stars">
            <% 5.times do |i| %>
              <svg class="rating-star-empty w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
              </svg>
            <% end %>
          </div>
          <span class="text-sm text-gray-600">(0 reviews)</span>
        </div>
      </div>

      <!-- Price -->
      <div class="border-t border-b border-gray-200 py-6">
        <div class="flex items-center space-x-4">
          <span class="text-3xl font-bold text-gray-900">$<%= @product.price %></span>

          <% if @product.compare_at_price && @product.compare_at_price > @product.price %>
            <span class="text-lg text-gray-500 line-through">$<%= @product.compare_at_price %></span>
            <% discount_percent = ((@product.compare_at_price - @product.price) / @product.compare_at_price * 100).round %>
            <span class="bg-red-100 text-red-800 px-2 py-1 rounded-full text-sm font-medium">
              Save <%= discount_percent %>%
            </span>
          <% end %>
        </div>

        <!-- Stock Status -->
        <div class="mt-4">
          <% if @product.track_inventory? %>
            <% case @product.stock_status %>
            <% when 'in_stock' %>
              <p class="text-green-600 font-medium">✓ In Stock (<%= @product.inventory_quantity %> available)</p>
            <% when 'low_stock' %>
              <p class="text-yellow-600 font-medium">⚠ Low Stock (<%= @product.inventory_quantity %> left)</p>
            <% when 'out_of_stock' %>
              <p class="text-red-600 font-medium">✗ Out of Stock</p>
            <% end %>
          <% else %>
            <p class="text-green-600 font-medium">✓ Available</p>
          <% end %>
        </div>
      </div>

      <!-- Short Description -->
      <% if @product.short_description.present? %>
        <div>
          <p class="text-lg text-gray-600"><%= @product.short_description %></p>
        </div>
      <% end %>

      <!-- Add to Cart Form -->
      <div class="space-y-4"
           data-controller="add-to-cart"
           data-add-to-cart-product-id-value="<%= @product.id %>"
           data-add-to-cart-in-stock-value="<%= @product.stock_status != 'out_of_stock' %>"
           data-base-price="<%= @product.price %>"
           data-stock-quantity="<%= @product.track_inventory? ? @product.inventory_quantity : 999 %>">
        <% unless @product.track_inventory? && @product.stock_status == 'out_of_stock' %>
          <div class="flex items-center space-x-4">
            <label for="quantity" class="text-sm font-medium text-gray-700">Quantity:</label>
            <div class="flex items-center border border-gray-300 rounded-md">
              <button type="button"
                      class="p-2 text-gray-400 hover:text-gray-600"
                      data-action="click->add-to-cart#decreaseQuantity">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                </svg>
              </button>
              <input type="number"
                     id="quantity"
                     name="quantity"
                     min="1"
                     max="<%= @product.track_inventory? ? @product.inventory_quantity : 999 %>"
                     value="1"
                     class="w-16 text-center border-0 focus:ring-0"
                     data-add-to-cart-target="quantityInput"
                     data-action="input->add-to-cart#quantityChanged">
              <button type="button"
                      class="p-2 text-gray-400 hover:text-gray-600"
                      data-action="click->add-to-cart#increaseQuantity">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                </svg>
              </button>
            </div>

            <!-- Total Price Display -->
            <div class="text-lg font-semibold text-gray-900">
              Total: <span data-add-to-cart-target="priceDisplay">$<%= @product.price %></span>
            </div>
          </div>

          <%= form_with url: cart_items_path, method: :post, local: false,
              data: {
                add_to_cart_target: "form",
                action: "submit->add-to-cart#submit"
              } do |form| %>
            <%= form.hidden_field :product_id, value: @product.id %>
            <%= form.hidden_field :quantity, value: 1 %>

            <div class="flex space-x-4">
              <button type="submit"
                      class="btn btn-primary btn-lg flex-1"
                      data-add-to-cart-target="submitButton">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4m0 0L7 13m0 0l-1.5 6M7 13l-1.5 6m0 0h9m-9 0h9"></path>
                </svg>
                Add to Cart
              </button>

              <button type="button"
                      class="btn btn-outline-primary btn-lg"
                      data-action="click->add-to-cart#addToWishlist"
                      data-product-id="<%= @product.id %>">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                </svg>
              </button>
            </div>
          <% end %>
        <% else %>
          <div class="text-center py-4">
            <p class="text-red-600 font-medium mb-4">This product is currently out of stock</p>
            <button class="btn btn-outline-primary">
              Notify When Available
            </button>
          </div>
        <% end %>
      </div>

      <!-- Product Details -->
      <div class="border-t border-gray-200 pt-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4">Product Details</h3>

        <dl class="space-y-2">
          <% if @product.sku.present? %>
            <div class="flex">
              <dt class="text-sm font-medium text-gray-500 w-24">SKU:</dt>
              <dd class="text-sm text-gray-900"><%= @product.sku %></dd>
            </div>
          <% end %>

          <% if @product.category.present? %>
            <div class="flex">
              <dt class="text-sm font-medium text-gray-500 w-24">Category:</dt>
              <dd class="text-sm text-gray-900"><%= @product.category.name %></dd>
            </div>
          <% end %>

          <% if @product.weight.present? %>
            <div class="flex">
              <dt class="text-sm font-medium text-gray-500 w-24">Weight:</dt>
              <dd class="text-sm text-gray-900"><%= @product.weight %> lbs</dd>
            </div>
          <% end %>

          <% if @product.length.present? && @product.width.present? && @product.height.present? %>
            <div class="flex">
              <dt class="text-sm font-medium text-gray-500 w-24">Dimensions:</dt>
              <dd class="text-sm text-gray-900">
                <%= @product.length %>" × <%= @product.width %>" × <%= @product.height %>"
              </dd>
            </div>
          <% end %>
        </dl>
      </div>
    </div>
  </div>

  <!-- Product Description & Details Tabs -->
  <div class="mb-16" data-controller="tabs" data-tabs-default-tab-value="description">
    <div class="border-b border-gray-200">
      <nav class="-mb-px flex space-x-8">
        <button class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm"
                data-action="click->tabs#switch"
                data-tab="description"
                data-tabs-target="tab">
          Description
        </button>
        <button class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm"
                data-action="click->tabs#switch"
                data-tab="reviews"
                data-tabs-target="tab">
          Reviews (0)
        </button>
        <button class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm"
                data-action="click->tabs#switch"
                data-tab="specifications"
                data-tabs-target="tab">
          Specifications
        </button>
      </nav>
    </div>

    <div class="mt-8">
      <!-- Description Tab -->
      <div class="tab-content"
           data-tab="description"
           data-tabs-target="panel"
           aria-hidden="false">
        <% if @product.description.present? %>
          <div class="prose prose-sm max-w-none text-gray-600">
            <%= simple_format(@product.description) %>
          </div>
        <% else %>
          <p class="text-gray-500 italic">No detailed description available for this product.</p>
        <% end %>
      </div>

      <!-- Reviews Tab -->
      <div class="tab-content hidden"
           data-tab="reviews"
           data-tabs-target="panel"
           aria-hidden="true">
        <div class="text-center py-12">
          <svg class="w-12 h-12 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
          </svg>
          <h3 class="text-lg font-medium text-gray-900 mb-2">No reviews yet</h3>
          <p class="text-gray-500 mb-6">Be the first to share your thoughts about this product!</p>
          <button class="btn btn-primary">Write a Review</button>
        </div>
      </div>

      <!-- Specifications Tab -->
      <div class="tab-content hidden"
           data-tab="specifications"
           data-tabs-target="panel"
           aria-hidden="true">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <dl class="space-y-4">
            <% if @product.sku.present? %>
              <div class="flex">
                <dt class="text-sm font-medium text-gray-500 w-32">SKU:</dt>
                <dd class="text-sm text-gray-900"><%= @product.sku %></dd>
              </div>
            <% end %>

            <% if @product.category.present? %>
              <div class="flex">
                <dt class="text-sm font-medium text-gray-500 w-32">Category:</dt>
                <dd class="text-sm text-gray-900"><%= @product.category.name %></dd>
              </div>
            <% end %>

            <% if @product.weight.present? %>
              <div class="flex">
                <dt class="text-sm font-medium text-gray-500 w-32">Weight:</dt>
                <dd class="text-sm text-gray-900"><%= @product.weight %> lbs</dd>
              </div>
            <% end %>

            <% if @product.length.present? && @product.width.present? && @product.height.present? %>
              <div class="flex">
                <dt class="text-sm font-medium text-gray-500 w-32">Dimensions:</dt>
                <dd class="text-sm text-gray-900">
                  <%= @product.length %>" × <%= @product.width %>" × <%= @product.height %>"
                </dd>
              </div>
            <% end %>
          </dl>
        </div>
      </div>
    </div>
  </div>

  <!-- Related Products -->
  <% if @related_products.any? %>
    <section>
      <h2 class="text-2xl font-bold text-gray-900 mb-8">You Might Also Like</h2>

      <div class="product-grid">
        <% @related_products.each do |product| %>
          <%= render 'shared/product_card', product: product %>
        <% end %>
      </div>
    </section>
  <% end %>
</div>
