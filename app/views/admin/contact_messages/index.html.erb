<% content_for(:title, "Contact Messages") %>

<div class="mb-6">
  <div class="flex justify-between items-center">
    <div>
      <h1 class="text-2xl font-bold text-gray-900">Contact Messages</h1>
      <p class="text-gray-600">Manage customer inquiries and messages</p>
    </div>

    <div class="flex items-center space-x-4">
      <% if @pending_messages_count > 0 %>
        <div class="bg-red-100 text-red-800 px-3 py-1 rounded-full text-sm font-medium">
          <%= @pending_messages_count %> new message<%= @pending_messages_count == 1 ? '' : 's' %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<!-- Filters and Search -->
<div class="bg-white rounded-lg shadow-sm p-6 mb-6">
  <%= form_with url: admin_contact_messages_path, method: :get, local: true, class: "flex flex-wrap items-end gap-4" do |form| %>
    <div class="flex-1 min-w-64">
      <%= form.text_field :search,
          value: params[:search],
          placeholder: "Search messages...",
          class: "form-input w-full",
          onkeypress: "if(event.key==='Enter'){this.form.submit();}" %>
    </div>

    <div>
      <%= form.select :status,
          options_for_select([
            ['All Messages', ''],
            ['Pending', 'pending'],
            ['Read', 'read'],
            ['Replied', 'replied'],
            ['Archived', 'archived']
          ], params[:status]),
          {},
          { class: "form-select" } %>
    </div>

    <div class="flex gap-2">
      <%= form.submit "Search & Filter", class: "btn btn-primary" %>
      <%= link_to "Clear", admin_contact_messages_path, class: "btn btn-outline-secondary" %>
    </div>
  <% end %>
</div>

<!-- Bulk Actions -->
<% if @contact_messages.any? %>
  <%= form_with url: bulk_action_admin_contact_messages_path, method: :post, local: true, class: "mb-4", id: "bulk-action-form" do |form| %>
    <div class="bg-white rounded-lg shadow-sm p-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-4">
          <label class="text-sm font-medium text-gray-700">
            <input type="checkbox" id="select-all" class="form-checkbox">
            Select All
          </label>

          <%= form.select :bulk_action,
              options_for_select([
                ['Mark as Pending', 'mark_as_pending'],
                ['Mark as Read', 'mark_as_read'],
                ['Mark as Replied', 'mark_as_replied'],
                ['Archive', 'archive'],
                ['Delete', 'delete']
              ]),
              { prompt: 'Choose action...' },
              { class: "form-select", required: true } %>
        </div>

        <%= form.submit "Apply", class: "btn btn-primary", id: "bulk-apply-btn",
            data: { "turbo-confirm": "Are you sure you want to apply this action to selected messages?" } %>
      </div>
    </div>
  <% end %>
<% end %>

<!-- Messages List -->
<div class="bg-white rounded-lg shadow-sm overflow-hidden">
  <% if @contact_messages.any? %>
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              <input type="checkbox" id="header-checkbox" class="form-checkbox">
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Status
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              From
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Subject
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Message Preview
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Date
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Actions
            </th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <% @contact_messages.each do |message| %>
            <tr class="<%= 'bg-blue-50' if message.pending? %> hover:bg-gray-50">
              <td class="px-6 py-4 whitespace-nowrap">
                <input type="checkbox" name="message_ids[]" value="<%= message.id %>"
                       class="form-checkbox message-checkbox">
              </td>

              <td class="px-6 py-4 whitespace-nowrap">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                           <%= case message.status
                               when 'pending' then 'bg-red-100 text-red-800'
                               when 'read' then 'bg-yellow-100 text-yellow-800'
                               when 'replied' then 'bg-green-100 text-green-800'
                               when 'archived' then 'bg-gray-100 text-gray-800'
                               end %>">
                  <%= message.status.titleize %>
                </span>
              </td>

              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm font-medium text-gray-900"><%= message.name %></div>
                <div class="text-sm text-gray-500"><%= message.email %></div>
              </td>

              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-gray-900 font-medium">
                  <%= link_to message.subject, admin_contact_message_path(message),
                      class: "hover:text-purple-600 transition-colors" %>
                </div>
              </td>

              <td class="px-6 py-4">
                <%= link_to admin_contact_message_path(message), class: "text-sm text-gray-500 hover:text-gray-700 max-w-xs truncate block transition-colors" do %>
                  <%= message.short_message(80) %>
                <% end %>
              </td>

              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                <%= time_ago_in_words(message.created_at) %> ago
              </td>

              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                <div class="flex flex-wrap gap-2">
                  <%= link_to "View", admin_contact_message_path(message),
                      class: "text-purple-600 hover:text-purple-900" %>

                  <!-- Status change actions -->
                  <% unless message.pending? %>
                    <%= form_with url: mark_as_pending_admin_contact_message_path(message), method: :patch, local: true, style: "display: inline;" do |form| %>
                      <%= form.submit "Mark Pending", class: "text-orange-600 hover:text-orange-900 bg-transparent border-none cursor-pointer underline text-sm" %>
                    <% end %>
                  <% end %>

                  <% unless message.read? %>
                    <%= form_with url: mark_as_read_admin_contact_message_path(message), method: :patch, local: true, style: "display: inline;" do |form| %>
                      <%= form.submit "Mark Read", class: "text-blue-600 hover:text-blue-900 bg-transparent border-none cursor-pointer underline text-sm" %>
                    <% end %>
                  <% end %>

                  <% unless message.replied? %>
                    <%= form_with url: mark_as_replied_admin_contact_message_path(message), method: :patch, local: true, style: "display: inline;" do |form| %>
                      <%= form.submit "Mark Replied", class: "text-green-600 hover:text-green-900 bg-transparent border-none cursor-pointer underline text-sm" %>
                    <% end %>
                  <% end %>

                  <%= link_to "Delete", admin_contact_message_path(message),
                      data: {
                        "turbo-method": :delete,
                        "turbo-confirm": "Are you sure you want to delete this message?"
                      },
                      class: "text-red-600 hover:text-red-900" %>
                </div>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  <% else %>
    <div class="text-center py-12">
      <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
      </svg>
      <h3 class="mt-2 text-sm font-medium text-gray-900">No contact messages</h3>
      <p class="mt-1 text-sm text-gray-500">
        <%= params[:search].present? || params[:status].present? ?
            "No messages match your current filters." :
            "No customer messages have been received yet." %>
      </p>
      <% if params[:search].present? || params[:status].present? %>
        <%= link_to "Clear filters", admin_contact_messages_path, class: "btn btn-primary mt-4" %>
      <% end %>
    </div>
  <% end %>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Handle select all functionality
  const selectAllCheckbox = document.getElementById('select-all');
  const messageCheckboxes = document.querySelectorAll('.message-checkbox');
  const bulkForm = document.getElementById('bulk-action-form');
  const bulkApplyBtn = document.getElementById('bulk-apply-btn');

  if (selectAllCheckbox) {
    selectAllCheckbox.addEventListener('change', function() {
      messageCheckboxes.forEach(checkbox => {
        checkbox.checked = this.checked;
      });
      updateBulkActionState();
    });
  }

  // Update select all when individual checkboxes change
  messageCheckboxes.forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      updateSelectAllState();
      updateBulkActionState();
    });
  });

  // Handle bulk action form submission
  if (bulkForm) {
    bulkForm.addEventListener('submit', function(e) {
      const checkedBoxes = document.querySelectorAll('.message-checkbox:checked');
      const actionSelect = document.querySelector('#bulk_action');

      if (checkedBoxes.length === 0) {
        e.preventDefault();
        alert('Please select at least one message.');
        return false;
      }

      if (!actionSelect.value) {
        e.preventDefault();
        alert('Please choose an action.');
        return false;
      }

      // Add selected message IDs to the form
      const existingInputs = bulkForm.querySelectorAll('input[name="message_ids[]"]');
      existingInputs.forEach(input => input.remove());

      checkedBoxes.forEach(checkbox => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'message_ids[]';
        input.value = checkbox.value;
        bulkForm.appendChild(input);
      });
    });
  }

  function updateSelectAllState() {
    const checkedCount = document.querySelectorAll('.message-checkbox:checked').length;
    const totalCount = messageCheckboxes.length;

    if (selectAllCheckbox) {
      selectAllCheckbox.checked = checkedCount === totalCount;
      selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < totalCount;
    }
  }

  function updateBulkActionState() {
    const checkedCount = document.querySelectorAll('.message-checkbox:checked').length;
    if (bulkApplyBtn) {
      bulkApplyBtn.disabled = checkedCount === 0;
      if (checkedCount === 0) {
        bulkApplyBtn.classList.add('opacity-50', 'cursor-not-allowed');
      } else {
        bulkApplyBtn.classList.remove('opacity-50', 'cursor-not-allowed');
      }
    }
  }

  // Initialize the state
  updateBulkActionState();
});
</script>
